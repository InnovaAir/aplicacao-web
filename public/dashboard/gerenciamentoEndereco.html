<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gerenciamento de Métrica</title>
  <script src="https://cdn.jsdelivr.net/npxm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../styles/estilo.css">
   <link rel="icon" href="../assets/favicon.ico" type="image/x-icon" />
</head>
<body>

<div class="sidebar" id="sidebar">
  <div class="d-flex justify-content-center align-items-center px-3 w-100">
        <div class="logo">
          <img src="../assets/InnovaairWhite.png" alt="Logo">
        </div>
    <button class="btn btn-light d-lg-none" type="button" onclick="toggleSidebar()" style="border-radius: 8px;  position:absolute;right:5vw; ">
      ☰
    </button>
  </div>

  <nav class="flex-column">
    <a href="visaoGeral.html">Visão geral</a>
    <a href="tempoReal.html">Tempo real</a>
    <a href="listaMaquinas.html">Lista de máquinas</a>
    <a href="NovosCadastros.html"><strong>Cadastrar Máquina</strong></a>
    <a href="suporte.html">Suporte</a>
    <div class="logout mt-3">
      <a href="NovosCadastros.html"><strong>Sair</strong></a>
    </div>
  </nav>
</div>

<div class="main d-flex justify-content-center align-items-center">
  <div id="tela" class="form-card container-fluid bg-white w-100">
    <div class="row">
      <div class="col-12">
        <div class="tituloContainer">
          <h1>Gerenciamento de Endereços</h1>
        </div>
      </div>

      <div class="col-12 mb-4">
        <div class="subtituloContainer">
          <div style="width: 40%; margin-top:10px">
            <button class="exibir" onclick="modalAdicionar()">Adicionar novo endereço</button>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="row">
          <!-- Repetir as divs de endereço com a mesma estrutura do exemplo dado -->
          <div class="col-md-4 mb-3">
            <div class="card maquina-generic">
              <div class="card-body">
                <h5 class="card-title" id="endereco_1">CEP - Logradouro, Número (Bairro)</h5>
                <p class="card-text" id="endereco_2">Cidade (Estado)</p>
                <div>
                  <button class="btn btn-primary" onclick="modalEdicao()">Editar</button>
                  <button class="btn btn-danger" onclick="modalConfirmarExclusao()">Excluir</button>
                </div>
              </div>
            </div>
          </div>
            <div class="section1">
                <div id="grid-enderecos" class="grid-maquinas">
                    <div class="maquina-generic">
                        <span id="endereco_1">CEP - Logradouro, Número (Bairro)</span>
                        <span id="endereco_2">Cidade (Estado)</span>
                        <div>
                            <button class="exibir" onclick="modalEdicao()">Editar</button>
                            <button class="exibir" onclick="modalConfirmarExclusao()">Excluir</button>
                        </div>
                    </div>
                    <div class="maquina-generic">
                        <span id="endereco_1">CEP - Logradouro, Número (Bairro)</span>
                        <span id="endereco_2">Cidade (Estado)</span>
                        <div>
                            <button class="exibir" onclick="modalEdicao()">Editar</button>
                            <button class="exibir" onclick="modalConfirmarExclusao()">Excluir</button>
                        </div>
                    </div>
                    <div class="maquina-generic">
                        <span id="endereco_1">CEP - Logradouro, Número (Bairro)</span>
                        <span id="endereco_2">Cidade (Estado)</span>
                        <div>
                            <button class="exibir" onclick="modalEdicao()">Editar</button>
                            <button class="exibir" onclick="modalConfirmarExclusao()">Excluir</button>
                        </div>
                    </div>

          <div class="col-md-4 mb-3">
            <div class="card maquina-generic">
              <div class="card-body">
                <h5 class="card-title" id="endereco_1">CEP - Logradouro, Número (Bairro)</h5>
                <p class="card-text" id="endereco_2">Cidade (Estado)</p>
                <div>
                  <button class="btn btn-primary" onclick="modalEdicao()">Editar</button>
                  <button class="btn btn-danger" onclick="modalConfirmarExclusao()">Excluir</button>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4 mb-3">
            <div class="card maquina-generic">
              <div class="card-body">
                <h5 class="card-title" id="endereco_1">CEP - Logradouro, Número (Bairro)</h5>
                <p class="card-text" id="endereco_2">Cidade (Estado)</p>
                <div>
                  <button class="btn btn-primary" onclick="modalEdicao()">Editar</button>
                  <button class="btn btn-danger" onclick="modalConfirmarExclusao()">Excluir</button>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4 mb-3">
            <div class="card maquina-generic">
              <div class="card-body">
                <h5 class="card-title" id="endereco_1">CEP - Logradouro, Número (Bairro)</h5>
                <p class="card-text" id="endereco_2">Cidade (Estado)</p>
                <div>
                  <button class="btn btn-primary" onclick="modalEdicao()">Editar</button>
                  <button class="btn btn-danger" onclick="modalConfirmarExclusao()">Excluir</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('show');
  }

    // Fechei as chaves da função 04-05-25
    function modalAdicionar(idMaquina) {
        Swal.fire({
            title: `Adicioar nova métrica</i>`,
            html: `
            <div class="container-update">
                <div class="row-modal">
                    <span>Métrica:</span> <input id="metrica" type="text" placeholder="Insira a métrica">
                </div>
                <div class="row-modal">
                    <span>Limite máximo:</span> <input id="metrica" type="text" placeholder="Insira o limite máximo">
                </div>
                <div class="row-modal">
                    <span>Limite mínimo:</span> <input id="metrica" type="text" placeholder="Insira o limite mínimo">
                </div>
                <p>Caso queira deixar a métrica sem limite, deixe o campo vázio.</p>
            </div>  
            `,
            showCloseButton: false,
            showCancelButton: true,
            focusConfirm: false,
            confirmButtonColor: '#5573ff',
            confirmButtonText: `<i class=""></i> Confirmar`,
            cancelButtonColor: 'red',
            cancelButtonText: `<i class=""></i> Cancelar`
        });

    }
    // Plotar os endereços existentes
    document.body.onload = exibirEnderecos()

    function exibirEnderecos() {
        document.getElementById("grid-enderecos").innerHTML = ``;


        fetch(`/cadastros/enderecos/listar/${sessionStorage.CLIENTE_USUARIO}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then((answer) => {
                answer.json().then((array_json) => {
                    if (array_json.length == 0) {
                        Swal.fire({
                            title: "Não há endereços sem atribuição cadastrados!",
                            text: `Cadastre endereços para eles aparecerem aqui!`,
                            icon: "info"
                        })
                    }

                    for (let i = 0; i < array_json.length; i++) {
                        const endereco = array_json[i];

                        document.getElementById("grid-enderecos").innerHTML += `
                        <div class="maquina-generic">
                            <span id="endereco_1">${endereco.cep} - ${endereco.logradouro}, ${endereco.numero} - ${endereco.complemento} (${endereco.bairro})</span>
                            <span id="endereco_2">${endereco.cidade} (${endereco.estado})</span>
                            <div>
                                <button class="exibir" onclick="modalEdicao(${endereco.idEndereco})">Editar</button>
                                <button class="exibir" onclick="modalConfirmarExclusao(${endereco.idEndereco}, '${endereco.cep + " - " + "(" + endereco.estado})')">Excluir</button>
                            </div>
                        </div>
            `
                    }
                })
            })
    }

    
    function modalEdicao(idMetrica, nomeMetrica, limiteMaximo, limiteMinimo) {
        
    function modalEdicao(idEndereco) {
        fetch(`/cadastros/enderecos/ver-unico/${idEndereco}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json",
            },
        }).then((answer) => {
            answer.json().then((endereco) => {
                endereco = endereco[0];

                Swal.fire({
                    title: `Atualização do Endereço <br> <i id='metrica-selecionada'>${endereco.logradouro}</i>`,
                    html: `
                        <div class="container-update">
                            <div class="row-modal">
                                <span>CEP:</span> <input id="cep" type="text" value="${endereco.cep}">
                            </div>
                            <div class="row-modal">
                                <span>Logradouro:</span> <input id="logradouro" type="text" value="${endereco.logradouro}">
                            </div>
                            <div class="row-modal">
                                <span>Número:</span> <input id="numero" type="text" value="${endereco.numero}">
                            </div>
                            <div class="row-modal">
                                <span>Complemento:</span> <input id="complemento" type="text" value="${endereco.complemento}">
                            </div>
                            <div class="row-modal">
                                <span>Bairro:</span> <input id="bairro" type="text" value="${endereco.bairro}">
                            </div>
                            <div class="row-modal">
                                <span>Cidade:</span> <input id="cidade" type="text" value="${endereco.cidade}">
                            </div>
                            <div class="row-modal">
                                <span>Estado:</span> <input id="estado" type="text" value="${endereco.estado}">
                            </div>
                        </div >
                        `,
                    showCloseButton: false,
                    showCancelButton: true,
                    focusConfirm: false,
                    confirmButtonColor: '#5573ff',
                    confirmButtonText: `<i class="">Confirmar</i>`,
                    cancelButtonColor: 'red',
                    cancelButtonText: `<i class="">Cancelar</i>`
                })
                    .then((log) => {
                        if (log.isConfirmed) {
                            var new_cep = document.getElementById("cep");
                            var new_logradouro = document.getElementById("logradouro");
                            var new_numero = document.getElementById("numero");
                            var new_complemento = document.getElementById("complemento");
                            var new_bairro = document.getElementById("bairro");
                            var new_cidade = document.getElementById("cidade");
                            var new_estado = document.getElementById("estado");
                            var new_regiao = document.getElementById("regiao");


                            var campo_incorreto = null;

                            if (new_cep.value == null || new_cep.value == `` || new_cep.value == ` ` || isNaN(new_cep.value)) {
                                campo_incorreto = "CEP"
                            } else if (new_logradouro.value == null || new_logradouro.value == `` || new_logradouro.value == ` `) {
                                campo_incorreto = "Logradouro"
                            } else if (new_numero.value == null || new_numero.value == `` || new_numero.value == ` `) {
                                campo_incorreto = "Número"
                            } else if (new_complemento.value == null || new_complemento.value == `` || new_complemento.value == ` `) {
                                campo_incorreto = "Complemento"
                            } else if (new_bairro.value == null || new_bairro.value == `` || new_bairro.value == ` `) {
                                campo_incorreto = "Bairro"
                            } else if (new_cidade.value == null || new_cidade.value == `` || new_cidade.value == ` `) {
                                campo_incorreto = "Cidade"
                            } else if (new_estado.value == null || new_estado.value == `` || new_estado.value == ` `) {
                                campo_incorreto = "Estado"
                            }

                            if (campo_incorreto != null) {
                                Swal.fire({
                                    title: "Campo incorreto!",
                                    text: `O campo: ${campo_incorreto} deve estar preenchido corretamente!`,
                                    icon: "error"
                                })
                            } else {
                                fetch(`/cadastros/enderecos/atualizar`, {
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify({
                                        fk: idEndereco,
                                        cep: new_cep.value,
                                        logradouro: new_logradouro.value,
                                        numero: new_numero.value,
                                        complemento: new_complemento.value,
                                        bairro: new_bairro.value,
                                        cidade: new_cidade.value,
                                        estado: new_estado.value,
                                        regiao: new_regiao.value,
                                    })
                                }).then((answer) => {
                                    exibirEnderecos()
                                    Swal.fire({
                                        title: "Atualização!",
                                        timer: 2000,
                                        text: `O endereço foi atualizado com sucesso!`,
                                        icon: "success"
                                    })
                                })
                            }
                        }
                    })
            })
        })
    }

    function modalConfirmarExclusao(idEndereco, logradouro) {
        Swal.fire({
            title: `Deseja realmente apagar o endereço <i> ${logradouro}</i> `,
            showCloseButton: false,
            showCancelButton: true,
            confirmButtonColor: '#5573ff',
            confirmButtonText: `<i class="" ></i > Confirmar`,
            cancelButtonColor: 'red',
            cancelButtonText: `<i class="" ></i > Cancelar`
        }).then((log) => {
            if (log.isConfirmed) {
                fetch(`/cadastros/enderecos/deletar/${idEndereco}`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                    },
                }).then((answer) => {
                    exibirEnderecos()
                    Swal.fire({
                        title: "Atualização!",
                        timer: 2000,
                        text: `O endereço foi apagado com sucesso!`,
                        icon: "success"
                    })
                })
            }
        })
    }


        // Só comentei tudo porque tava dando erro

        // Swal.fire({
        //     title: `Atualização da métrica <br> <i id='metrica-selecionada'>${nomeMetrica}</i>`,
        //     html: `
        //     <div class="container-update">
        //         <div class="row-modal">
        //             <span id="limite-maximo-exist">Limite Máximo:</span> <input type="text" value="${limiteMaximo}">
        //         </div>
        //         <div class="row-modal">
        //             <span id="limite-minimo-exist">Limite Mínimo:</span> <input type="text" value="${limiteMinimo}">
        //         </div>
        //     title: `Adicionar novo endereço</i > `,
        //     html: `
        //     <div class="container-update">
        //         <div class="row-modal">
        //             <span>CEP:</span> <input id="cep" type="text">
        //         </div>
        //         <div class="row-modal">
        //             <span>Logradouro:</span> <input id="logradouro" type="text">
        //         </div>
        //         <div class="row-modal">
        //             <span>Número:</span> <input id="numero" type="text">
        //         </div>
        //         <div class="row-modal">
        //             <span>Complemento:</span> <input id="complemento" type="text">
        //         </div>
        //         <div class="row-modal">
        //             <span>Bairro:</span> <input id="bairro" type="text">
        //         </div>
        //         <div class="row-modal">
        //             <span>Cidade:</span> <input id="cidade" type="text">
        //         </div>
        //         <div class="row-modal">
        //             <span>Estado:</span> <input id="estado" type="text">
        //         </div>
        //     </div>
        //     `,
        //     showCloseButton: false,
        //     showCancelButton: true,
        //     focusConfirm: false,
        //     confirmButtonColor: '#5573ff',
        //     confirmButtonText: `<i class="" >Confirmar</i>`,
        //     cancelButtonColor: 'red',
        //     cancelButtonText: `<i class=""></i> Cancelar`
        // });

        // var new_maximo = document.getElementById("limite-maximo-exist").value;
        // var new_minimo = document.getElementById("limite-minimo-exist").value;

    }

    function modalConfirmarExclusao(idMetrica) {
        Swal.fire({
            title: "Deseja realmente apagar a métrica ${nome?}",
            showCloseButton: false,
            showCancelButton: true,
            confirmButtonColor: '#5573ff',
            confirmButtonText: `<i class=""></i> Confirmar`,
            cancelButtonColor: 'red',
            cancelButtonText: `<i class=""></i> Cancelar`

            // Tava dando erro
            // cancelButtonText: `<i class="" >Cancelar</i>`
        }).then((log) => {
            if (log.isConfirmed) {
                var new_cep = document.getElementById("cep");
                var new_logradouro = document.getElementById("logradouro");
                var new_numero = document.getElementById("numero");
                var new_complemento = document.getElementById("complemento");
                var new_bairro = document.getElementById("bairro");
                var new_cidade = document.getElementById("cidade");
                var new_estado = document.getElementById("estado");

                var campo_incorreto = null;

                if (new_cep.value == null || new_cep.value == `` || new_cep.value == ` ` || isNaN(new_cep.value) || new_cep.value.length != 8) {
                    campo_incorreto = "CEP"
                } else if (new_logradouro.value == null || new_logradouro.value == `` || new_logradouro.value == ` `) {
                    campo_incorreto = "Logradouro"
                } else if (new_numero.value == null || new_numero.value == `` || new_numero.value == ` `) {
                    campo_incorreto = "Número"
                } else if (new_complemento.value == null || new_complemento.value == `` || new_complemento.value == ` `) {
                    campo_incorreto = "Complemento"
                } else if (new_bairro.value == null || new_bairro.value == `` || new_bairro.value == ` `) {
                    campo_incorreto = "Bairro"
                } else if (new_cidade.value == null || new_cidade.value == `` || new_cidade.value == ` `) {
                    campo_incorreto = "Cidade"
                } else if (new_estado.value == null || new_estado.value == `` || new_estado.value == ` `) {
                    campo_incorreto = "Estado"
                }

                if (campo_incorreto != null) {
                    // Campos incorretos
                    Swal.fire({
                        title: "Campo incorreto!",
                        text: `O campo: ${campo_incorreto} deve estar preenchido corretamente!`,
                        icon: "error"
                    })
                } else {
                    // Campos corretos
                    fetch(`/cadastros/enderecos/adicionar`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            cep: new_cep.value,
                            logradouro: new_logradouro.value,
                            numero: new_numero.value,
                            complemento: new_complemento.value,
                            bairro: new_bairro.value,
                            cidade: new_cidade.value,
                            estado: new_estado.value,
                        })
                    })
                        .then(() => {
                            exibirEnderecos()
                            Swal.fire({
                                title: "Atualização!",
                                timer: 2000,
                                text: `O endereço foi atualizado com sucesso!`,
                                icon: "success"
                            })
                        })
                }
            }
        })
    }

</script>