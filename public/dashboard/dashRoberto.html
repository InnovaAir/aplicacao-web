<!DOCTYPE html>
<html lang="en">

<head>
  <title>Visão geral</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../styles/menuLateral.css" />
  <link rel="stylesheet" href="../styles/dashRoberto.css" />
  <link rel="stylesheet" href="../styles/estilo.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../styles/sidebar_marcolino.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="../js/navbarHover.js"></script>
</head>

<body>
  <div class="container-fluid">
  <div class="row">
  <div style="width: 5vw;" class="sidebar d-flex flex-column align-items-center">  
    <div id="sidebar">
      <div class="logo d-flex justify-content-between align-items-center w-100 px-2">
        <img src="../assets/InnovaairWhite.png" alt="Logo" class="img-fluid" />
        <button id="closeSidebar" class="btn btn-sm btn-outline-primary">
          <i class="fas fa-arrow-left"></i>
        </button>
      </div>

      <a href="dashDudu.html"><i class="fas fa-chart-line"></i> <span>Desempenho</span></a>
      <a href="roberto_Lucas.html"><i class="fas fa-triangle-exclamation"></i> <span>Alertas</span></a>
      <a href="monitoramentoModelos.html"><i class="fas fa-desktop"></i> <span>Modelo de <br> Maquinas</span></a>
      <a href="dashRoberto.html"><i class="fas fa-microchip"></i> <span>Modelo de <br> Componentes</span></a>
      <a onclick="limparSessao()" href="../index.html"><strong>Sair</strong></a>
    </div>
  </div>
      
  <div id="tela" class="tamanho_dash">
    <div class="container_componente">
      <div class="titulo">
        <span id="titulo_01">
          <b>Análise Geral de Modelos</b>
        </span>
        <span id="titulo_02">
          <i><b>*Selecione os filtros para a visualização(aeroporto, período e componente)</b></i>
        </span>
      </div>

      <div class="select-wrapper">
        <div class="custom-select">
          <select id="select_aeroporto" onchange="aplicarFiltro()">
            <option value="" disabled selected>Selecione o Aeroporto</option>
            <option value="gru">GRU</option>
            <option value="cgh">Congonhas</option>
          </select>
        </div>

        <div class="custom-select">
          <select id="select_intervalo" onchange="aplicarFiltro()">
            <option value="" disabled>Selecione o intervalo</option>
            <option value="1">Últimos 7 dias</option>
            <option value="2">Últimos 14 dias</option>
            <option value="4" selected>Últimos 30 dias</option>
          </select>
        </div>

        <div class="custom-select">
          <select id="select_componente" onchange="aplicarFiltro()">
            <option value="" selected>Todos os componentes</option>
            <option value="cpu">CPU</option>
            <option value="ram">RAM</option>
            <option value="disco">DISCO</option>
            <option value="rede">REDE</option>
          </select>
        </div>
      </div>

            <div class="box_kpi">
        <div class="kpi_tabela">
          <h3 class="titulo_kpi">Modelo com mais alertas:</h3>
          <h1 id="valor_kpi1" class="valor_kpi"><b>i3 7200 u</b></h1>
          
        </div>
        <div class="kpi_tabela">
          <h3 class="titulo_kpi">Quantidade de máquinas com esse modelo:</h3>
          <h1 id="valor_kpi2"class="valor_kpi"><b>200</b></h1>
          
        </div>
        <div class="kpi_tabela">
          <h3 class="titulo_kpi">Capturas com alerta (%) desse modelo:</h3>
          <h1 id="valor_kpi3"class="valor_kpi"><b>95%</b></h1>
          
        </div>
        <div class="kpi_tabela">
          <h3 class="titulo_kpi">Modelo do mesmo componente com menos alertas:</h3>
          <h1 id="valor_kpi4"class="valor_kpi"><b>Ryzen 3 3200 GE</b></h1>
          
        </div>
      </div>

      <div class="box_grafico">
        <div class="grafico_alinhado">
          <div class="titulo_grafico1">
            <span id="titulo_01">
              Quantidade de alertas por modelo
            </span>
            <span id="titulo_02">
              <i>*Organizado pelos níveis de alerta.</i>
            </span>
          </div>
          <div class="grafico_01">
            <div id="chart_barras"></div>
          </div>
        </div>
        <div class="tabela">
          <div class="container_tabela">
            <div class="titulo_grafico3">
              <div class="titulo_alinhado">
                <span id="titulo_01">
                  Lista de Modelos
                </span>
                <span id="titulo_02">
                  <i>*Por nível de gravidade do alerta</i>
                </span>
              </div>
            </div>
          </div>
              <div class="tabela-alertas-div">
                <!-- Cabeçalho -->
                <div class="tabela-header">
                  <div class="col">Componente</div>
                  <div class="col">Total Alertas</div>
                  <div class="col">Qtd. máquinas c/ componente</div>
                  <div class="col">Porcentagem de alertas</div>
                </div>
              
                <!-- Linha 1 -->
                <div class="tabela-row">
                  <div class="col">
                    <span id="tabela_comp_1">Processador</span><br>
                    <small><span id="tabela_modelo_1">Ryzen 3 3200g</span></small>
                  </div>
                  <div class="col" id="tabela_total_1">7</div>
                  <div class="col" id="tabela_qtd_1">21</div>
                  <div class="col" id="tabela_perc_1">5%</div>
                </div>
              
                <!-- Linha 2 -->
                <div class="tabela-row">
                  <div class="col">
                    <span id="tabela_comp_2">Processador</span><br>
                    <small><span id="tabela_modelo_2">Ryzen 3 3200g</span></small>
                  </div>
                  <div class="col" id="tabela_total_2">576</div>
                  <div class="col" id="tabela_qtd_2">12</div>
                  <div class="col" id="tabela_perc_2">86%</div>
                </div>
              
                <!-- Linha 3 -->
                <div class="tabela-row">
                  <div class="col">
                    <span id="tabela_comp_3">Processador</span><br>
                    <small><span id="tabela_modelo_3">Ryzen 3 3200g</span></small>
                  </div>
                  <div class="col" id="tabela_total_3">1023</div>
                  <div class="col" id="tabela_qtd_3">43</div>
                  <div class="col" id="tabela_perc_3">43%</div>
                </div>
              
                <!-- Linha 4 -->
                <div class="tabela-row">
                  <div class="col">
                    <span id="tabela_comp_4">Processador</span><br>
                    <small><span id="tabela_modelo_4">Ryzen 3 3200g</span></small>
                  </div>
                  <div class="col" id="tabela_total_4">1023</div>
                  <div class="col" id="tabela_qtd_4">43</div>
                  <div class="col" id="tabela_perc_4">43%</div>
                </div>
              
                <!-- Linha 5 -->
                <div class="tabela-row">
                  <div class="col">
                    <span id="tabela_comp_5">Processador</span><br>
                    <small><span id="tabela_modelo_5">Ryzen 3 3200g</span></small>
                  </div>
                  <div class="col" id="tabela_total_5">1023</div>
                  <div class="col" id="tabela_qtd_5">43</div>
                  <div class="col" id="tabela_perc_5">43%</div>
                </div>
              </div>              
      </div>
      </div>
  </div>
</body>

</html>

  <!-- JQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap Bundle JS (popper + bootstrap) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let expanded = false;

  $('#sidebar').on('click', function () {
    if (!expanded) {
      $(this).addClass('expanded');
      expanded = true;
    }
  });

  $('#closeSidebar').on('click', function (e) {
    e.stopPropagation(); // Evita reabrir imediatamente
    $('#sidebar').removeClass('expanded');
    expanded = false;
  });
</script>

<script src="../js/animacaoMenu.js"></script>

<script>
let modelosOrdenados = []
let json_dados = {};
let qtdMaquinas = {};
let filiais = []
let json_filtrado = []
var periodo = 4
var menores = []
var options = {
    series: [
      {
        name: 'Baixo',
        data: [10, 10, 10, 10, 10]
      },
      {
        name: 'Alto',
        data: [14, 21, 23, 12, 12]
      },
      {
        name: 'Crítico',
        data: [2, 3, 5, 10, 10]
      }
    ],
    chart: {
      type: 'bar',
      height: 300
    },
    colors: ['#ff9900', '#ff0000', '#8400ff'],
    plotOptions: {
      bar: {
        horizontal: true,
        dataLabels: {
          position: 'top'
        }
      }
    },
    dataLabels: {
      enabled: true,
      offsetX: -6,
      style: {
        fontSize: '15px',
        colors: ['#00000']
      },
      formatter: function (val) {
        return val;
      }
    },
    stroke: {
      show: true,
      width: 1,
      colors: ['#fff']
    },
    tooltip: {
      shared: true,
      intersect: false
    },
    xaxis: {
      categories: ["i3 7200u", "i4 2322u", "ryzen 4", "pentium 5", "GEFORCE RTX"],
      max: 30
    },
    yaxis: {
      labels: {
        style: {
          fontSize: '16px' // aumenta a fonte do eixo Y
        }
      }      
    }
  };

var chart = new ApexCharts(document.querySelector("#chart_barras"), options);
chart.render();

  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('show');
  }
  

function selectPrenchido(){
  aeroporto = select_aeroporto.value
}
obterFiliaisGerente()

async function executar() {
await obterDadosGerente()
await ordenarDados(json_dados)
await obterDadosGerenteMenor()
plotarDados(json_dados, qtdMaquinas)
}
executar()
function obterFiliaisGerente(){

  fetch(`/cadastros/metricas/listar/filiais/${sessionStorage.idUsuario}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then((answer) => {
                answer.json().then(json_select => {
                    json_filiais = json_select;

                    var select_aeroporto = document.getElementById("select_aeroporto");

                    select_aeroporto.innerHTML = `<option disabled value="null">Selecione um aeroporto</option>`
                    select_aeroporto.innerHTML += `<option selected value="">Todos os meus aeroportos</option>`

                    for (let i = 0; i < json_filiais.length; i++) {
                        var filialAtual = json_filiais[i];

                        // Insere cada opção 
                        select_aeroporto.innerHTML += `<option value="${filialAtual.terminal}">${filialAtual.terminal}</option>`
                    }
                    for(i = 0; i < json_filiais.length; i++){
                      filiais.push(json_filiais[i].terminal)
                    }
                })
            })
            .catch(() => {
                print("Erro ao realizar o Fetch")
            });
    };

async function obterDadosGerente(){
    resposta = await fetch("/dashboards/dashGerenteDados", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
          idUsuarioServer: sessionStorage.idUsuario
        }),
    })

    json_dados = await resposta.json()
  }

async function obterDadosGerenteMenor(){
    resposta = await fetch(`/dashboards/obterDadosGerenteMenor/${sessionStorage.idUsuario}`, {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
        },
    })
    
    menores = await resposta.json()
    console.log(menores)
  }

function ordenarDados(json_dados){
  modelosOrdenados = []
  var modelos = []
  var baixo = 0;
  var alto = 0;
  var critico = 0;
  var qtdAtual = 0;
  var modelo = []
  var maquinas = []
  var qtdMaquinas1 = 0
  var qtdMaquinas2 = 0
  var qtdMaquinas3 = 0
  var qtdMaquinas4 = 0
  var qtdMaquinas5 = 0
  console.log(json_dados)
  for(i = 0; i < json_dados.length; i++){
    if(!modelos.includes(json_dados[i].especificacao)){
      modelos.push(json_dados[i].especificacao)
    }
  }
            for(i = 0; i < modelos.length; i++){
              baixo = 0;
              alto = 0;
              critico = 0;
              qtdAtual = 0;
              modelo = json_dados.filter(m => m.especificacao == modelos[i])
                for(j = 0; j < modelo.length; j++){
                  if(modelo[j].gravidade == 'baixo'){
                    baixo+=modelo[j].qtdAlertas
                  }
                  else if(modelo[j].gravidade == 'alto'){
                    alto+=modelo[j].qtdAlertas
                  }
                  else if(modelo[j].gravidade == 'critico'){
                    critico+=modelo[j].qtdAlertas
                  }
                qtdAtual+= modelo[j].qtdAlertas
                }
                modelo = {
                  "qtdAlertas":qtdAtual, 
                  "especificacao":modelo[0].especificacao, 
                  "componente":modelo[0].componente,
                  "terminal":modelo[0].terminal,
                  "alertas": [baixo, alto, critico]
                }
                modelosOrdenados.push(modelo)
              }
                for(i = 0; i < modelosOrdenados.length; i++){
                  indexMaior = i
                  for(j = i; j < modelosOrdenados.length; j++){
                    if(modelosOrdenados[j].qtdAlertas > modelosOrdenados[indexMaior].qtdAlertas){
                      indexMaior = j
                    }
                  }
                  temp = modelosOrdenados[i]
                  modelosOrdenados[i] = modelosOrdenados[indexMaior]
                  modelosOrdenados[indexMaior] = temp
                }
                for(i = 0; i < json_dados.length; i++){
                  if(json_dados[i].especificacao == modelosOrdenados[0].especificacao && !maquinas.includes(json_dados[i].idMaquina)){
                    maquinas.push(json_dados[i].idMaquina)
                    qtdMaquinas1++
                  }
                  if(json_dados[i].especificacao == modelosOrdenados[1].especificacao && !maquinas.includes(json_dados[i].idMaquina)){
                    maquinas.push(json_dados[i].idMaquina)
                    qtdMaquinas2++
                  }
                  if(json_dados[i].especificacao == modelosOrdenados[2].especificacao && !maquinas.includes(json_dados[i].idMaquina)){
                    maquinas.push(json_dados[i].idMaquina)
                    qtdMaquinas3++
                  }
                  if(json_dados[i].especificacao == modelosOrdenados[3].especificacao && !maquinas.includes(json_dados[i].idMaquina)){
                    maquinas.push(json_dados[i].idMaquina)
                    qtdMaquinas4++
                  }
                    if(json_dados[i].especificacao == modelosOrdenados[4].especificacao && !maquinas.includes(json_dados[i].idMaquina)){
                    maquinas.push(json_dados[i].idMaquina)
                    qtdMaquinas5++
                  }
                }
                qtdMaquinas = [qtdMaquinas1, qtdMaquinas2, qtdMaquinas3, qtdMaquinas4, qtdMaquinas5]
}
function plotarDados(json_dados, qtdMaquinas){
                 alertaBaixo = [modelosOrdenados[0].alertas[0], modelosOrdenados[1].alertas[0], modelosOrdenados[2].alertas[0], modelosOrdenados[3].alertas[0], modelosOrdenados[4].alertas[0]]
                 alertaAlto = [modelosOrdenados[0].alertas[1], modelosOrdenados[1].alertas[1], modelosOrdenados[2].alertas[1], modelosOrdenados[3].alertas[1], modelosOrdenados[4].alertas[1]]
                 alertaCritico = [modelosOrdenados[0].alertas[2], modelosOrdenados[2].alertas[2], modelosOrdenados[2].alertas[2], modelosOrdenados[3].alertas[2], modelosOrdenados[4].alertas[2]]
                 nomesModelos = [modelosOrdenados[0].especificacao, modelosOrdenados[1].especificacao, modelosOrdenados[2].especificacao, modelosOrdenados[3].especificacao, modelosOrdenados[4].especificacao]
                max = modelosOrdenados[0].qtdAlertas
                chart.updateSeries([
                  {
                    name: 'Baixo',
                    data: alertaBaixo
                  },
                  {
                    name: 'Alto',
                    data: alertaAlto
                  },
                  {
                    name: 'Critico',
                    data: alertaCritico
                  }
                ])
                chart.updateOptions({
                  xaxis: {
                    categories: nomesModelos,
                    max: max,
                    forceNiceScale: false
                  }
                });
                tabela_comp_1.innerHTML = modelosOrdenados[0].componente
                tabela_comp_2.innerHTML = modelosOrdenados[1].componente
                tabela_comp_3.innerHTML = modelosOrdenados[2].componente
                tabela_comp_4.innerHTML = modelosOrdenados[3].componente
                tabela_comp_5.innerHTML = modelosOrdenados[4].componente
                tabela_modelo_1.innerHTML = modelosOrdenados[0].especificacao
                tabela_modelo_2.innerHTML = modelosOrdenados[1].especificacao
                tabela_modelo_3.innerHTML = modelosOrdenados[2].especificacao
                tabela_modelo_4.innerHTML = modelosOrdenados[3].especificacao
                tabela_modelo_5.innerHTML = modelosOrdenados[4].especificacao
                tabela_total_1.innerHTML = modelosOrdenados[0].qtdAlertas
                tabela_total_2.innerHTML = modelosOrdenados[1].qtdAlertas
                tabela_total_3.innerHTML = modelosOrdenados[2].qtdAlertas
                tabela_total_4.innerHTML = modelosOrdenados[3].qtdAlertas
                tabela_total_5.innerHTML = modelosOrdenados[4].qtdAlertas
                tabela_qtd_1.innerHTML = qtdMaquinas[0];
                tabela_qtd_2.innerHTML = qtdMaquinas[1];
                tabela_qtd_3.innerHTML = qtdMaquinas[2];
                tabela_qtd_4.innerHTML = qtdMaquinas[3];
                tabela_qtd_5.innerHTML = qtdMaquinas[4];
                tabela_perc_1.innerHTML = Math.round(modelosOrdenados[0].qtdAlertas*100/(qtdMaquinas[0] * 4 * 24 * periodo * 7)) + "%"
                tabela_perc_2.innerHTML = Math.round(modelosOrdenados[1].qtdAlertas*100/(qtdMaquinas[1] * 4 * 24 * periodo * 7)) + "%"
                tabela_perc_3.innerHTML = Math.round(modelosOrdenados[2].qtdAlertas*100/(qtdMaquinas[2] * 4 * 24 * periodo * 7)) + "%"
                tabela_perc_4.innerHTML = Math.round(modelosOrdenados[3].qtdAlertas*100/(qtdMaquinas[3] * 4 * 24 * periodo * 7)) + "%"
                tabela_perc_5.innerHTML = Math.round(modelosOrdenados[4].qtdAlertas*100/(qtdMaquinas[4] * 4 * 24 * periodo * 7)) + "%"
                valor_kpi1.innerHTML = modelosOrdenados[0].especificacao
                valor_kpi2.innerHTML = qtdMaquinas[0]
                valor_kpi3.innerHTML = Math.round(modelosOrdenados[0].qtdAlertas*100/(qtdMaquinas[0] * 4 * 24 * periodo * 7)) + "%"
                for(i = 0; i < menores.length; i++){
                  if(modelosOrdenados[0].componente == menores[i].componente){
                    valor_kpi4.innerHTML = menores[i].especificacao
                  }
                }
}

async function aplicarFiltro(){
  var aeroportos = document.getElementById("select_aeroporto")
  var aeroporto = aeroportos.value;
  var intervalo = parseInt(select_intervalo.value)
  var componente = select_componente.value
  dados_filtrados = json_dados;
  const componentes = {
    ram: "RAM",
    disco: "Armazenamento",
    rede: "Rede",
    cpu: "Processador"
  }
  const semanas = {
    "1": 1,
    "2": 2,
    "4": 4
  }
var hoje = new Date();
var semanaAtual = obterDiaSemana(hoje);
  if(componentes[componente]){
    dados_filtrados = dados_filtrados.filter(dado => dado.componente == componentes[componente])
  }
  
  // filtro endereco
  if(filiais.indexOf(aeroporto) != -1){
    var dados_filtrados2 = [];
        indice = filiais.indexOf(aeroporto)
      for (i = 0; i < dados_filtrados.length; i++){
      if(dados_filtrados[i].terminal == filiais[indice]){
        dados_filtrados2.push(json_dados[i])
    }
    }
    dados_filtrados = dados_filtrados2
  }

  if(semanas[intervalo]){
    periodo = semanas[intervalo]
    dados_filtrados = dados_filtrados.filter(dado => semanaAtual - dado.semanas <= semanas[intervalo])
  }
  // filtro endereco
  ordenarDados(dados_filtrados)
  await plotarDados(dados_filtrados, qtdMaquinas)
}

function obterDiaSemana(d) {
  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
  var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  var diaSemana = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);

  return diaSemana;
}

  abrirMenu();
</script>