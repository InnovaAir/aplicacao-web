<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../styles/menuLateral.css" />
  <link rel="stylesheet" href="../styles/dashRoberto.css" />
  <link rel="stylesheet" href="../styles/estilo.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <title>Visão geral</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>

  <div class="sidebar" id="sidebar">
    <div class="d-flex justify-content-center align-items-center px-3 w-100">
          <div class="logo">
            <img src="../assets/InnovaairWhite.png" alt="Logo">
          </div>
      <button class="btn btn-light d-lg-none" type="button" onclick="toggleSidebar()" style="border-radius: 8px;  position:absolute;right:5vw;">
        ☰
      </button>
    </div>
  
    <nav class="flex-column">
      <a href="visaoGeral.html">Visão geral</a>
      <a href="tempoReal.html">Tempo real</a>
      <a href="listaMaquinas.html">Lista de máquinas</a>
      <a href="NovosCadastros.html"><strong>Cadastrar Máquina</strong></a>
      <a href="suporte.html">Suporte</a>
      <div class="logout mt-3">
        <a href="NovosCadastros.html"><strong>Sair</strong></a>
      </div>
    </nav>
  </div>

  


  <div id="tela" class="tamanho_dash">
    <div class="container_componente">
      <div class="titulo">
        <span id="titulo_01">
          <b>Análise Geral por Endereço</b>
        </span>
        <span id="titulo_02">
          <i><b>*Selecione os filtros para a visualização(aeroporto, período e componente)</b></i>
        </span>
      </div>

      <div class="select-wrapper">
        <div class="custom-select">
          <select id="select_aeroporto">
            <option value="" disabled selected>Selecione o Aeroporto</option>
            <option value="gru">GRU</option>
            <option value="cgh">Congonhas</option>
          </select>
        </div>

        <div class="custom-select">
          <select id="select_intervalo">
            <option value="" disabled selected>Selecione o intervalo</option>
            <option value="7">Últimos 7 dias</option>
            <option value="15">Últimos 15 dias</option>
            <option value="30">Últimos 30 dias</option>
          </select>
        </div>

        <div class="custom-select">
          <select id="select_componente">
            <option value="" disabled selected>Todos os componentes</option>
            <option value="cpu">CPU</option>
            <option value="ram">RAM</option>
            <option value="disco">DISCO</option>
            <option value="rede">REDE</option>
          </select>
        </div>
      </div>

      <div class="box_kpi">
        <div class="kpi_tabela">
          <span id="titulo_kpi">Modelo com mais alertas:</span>
          <span id="valor_kpi"><b>i3 7200 u</b></span>
        </div>
        <div class="kpi_tabela">
          <span id="titulo_kpi">Modelo do mesmo componente com menos alertas:</span>
          <span id="valor_kpi"><b>Ryzen 3 3200 GE</b></span>
        </div>
      </div>

      <div class="box_grafico">
        <div class="grafico_alinhado">
          <div class="titulo_grafico1">
            <span id="titulo_01">
              Quantidade de alertas por modelo
            </span>
            <span id="titulo_02">
              <i>*Um componente pode emitir mais de um alerta, organizado pelos níveis de alerta.</i>
            </span>
          </div>
          <div class="grafico_01">
            <div id="chart_barras"></div>
          </div>
        </div>
      </div>

      <div>
        <div class="container_tabela">
          <div class="titulo_grafico3">
            <div class="titulo_alinhado">
              <span id="titulo_01">
                Lista de Modelos
              </span>
              <span id="titulo_02">
                <i>*Por nível de gravidade do alerta</i>
              </span>
            </div>
            
            <div class="select-wrapper">
              <div class="custom-select">
                <select id="select_aeroporto">
                  <option value="" disabled>Selecione o nível do alerta</option>
                  <option value="baixo">Baixo</option>
                  <option value="alto" selected>Alto</option>
                  <option value="critico">Crítico</option>
                </select>
              </div>
              
              <div class="custom-select">
                <select id="select_intervalo">
                  <option value="" selected disabled>Selecione o componente</option>
                  <option value="processador" selected>Processador</option>
                  <option value="ram">RAM</option>
                  <option value="disco">Disco</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="box_tabela">
          <div class="tabela-scroll">
            <table class="tabela-alertas">
              <thead>
                <tr>
                  <th>Componente</th>
                  <th>Total Alertas</th>
                  <th>Qtd. máquinas c/ componente</th>
                  <th>Porcentagem de alertas</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <span id="tabela_comp_1">Processador</span><br><small><span id="tabela_modelo_1">Ryzen 3 3200g</span></small>
                  </td>
                  <td id="tabela_total_1">7</td>
                  <td id="tabela_qtd_1">21</td>
                  <td id="tabela_perc_1">5%</td>
                </tr>
                <td>
                  <span id="tabela_comp_2">Processador</span><br><small><span id="tabela_modelo_2">Ryzen 3 3200g</span></small>
                </td>
                <td id="tabela_total_2">576</td>
                <td id="tabela_qtd_2">12</td>
                <td id="tabela_perc_2">86%</td>
                </tr>
                <tr>
                  <td>
                    <span id="tabela_comp_3">Processador</span><br><small><span id="tabela_modelo_3">Ryzen 3 3200g</span></small>
                  </td>
                  <td id="tabela_total_3">1023</td>
                  <td id="tabela_qtd_3">43</td>
                  <td id="tabela_perc_3">43%</td>
                </tr>
                                <tr>
                  <td>
                    <span id="tabela_comp_4">Processador</span><br><small><span id="tabela_modelo_4">Ryzen 3 3200g</span></small>
                  </td>
                  <td id="tabela_total_4">1023</td>
                  <td id="tabela_qtd_4">43</td>
                  <td id="tabela_perc_4">43%</td>
                </tr>
                                <tr>
                  <td>
                    <span id="tabela_comp_5">Processador</span><br><small><span id="tabela_modelo_5">Ryzen 3 3200g</span></small>
                  </td>
                  <td id="tabela_total_5">1023</td>
                  <td id="tabela_qtd_5">43</td>
                  <td id="tabela_perc_5">43%</td>
                </tr>
              </tbody>
            </table>
          </div>
          
        </div>
      </div>
    </div>
  </div>
</body>

</html>

<script src="../js/animacaoMenu.js"></script>

<script>
modelosOrdenados = []
var options = {
    series: [
      {
        name: 'Baixo',
        data: [10, 10, 10, 10]
      },
      {
        name: 'Alto',
        data: [14, 21, 23, 12]
      },
      {
        name: 'Crítico',
        data: [2, 3, 5, 10]
      }
    ],
    chart: {
      type: 'bar',
      height: 440
    },
    colors: ['#ff9900', '#ff0000', '#8400ff'],
    plotOptions: {
      bar: {
        horizontal: true,
        dataLabels: {
          position: 'top'
        }
      }
    },
    dataLabels: {
      enabled: true,
      offsetX: -6,
      style: {
        fontSize: '12px',
        colors: ['#fff']
      },
      formatter: function (val) {
        return val;
      }
    },
    stroke: {
      show: true,
      width: 1,
      colors: ['#fff']
    },
    tooltip: {
      shared: true,
      intersect: false
    },
    xaxis: {
      categories: ["i3 7200u", "i4 2322u", "ryzen 4", "pentium 5"],
      max: 30
    }
  };

var chart = new ApexCharts(document.querySelector("#chart_barras"), options);
chart.render();

  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('show');
  }
  
obterFiliaisGerente()
obterDadosGerente()
function obterFiliaisGerente(){

  fetch(`/cadastros/metricas/listar/filiais/${sessionStorage.idUsuario}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then((answer) => {
                answer.json().then(json_select => {
                    json_filiais = json_select;

                    var select_aeroporto = document.getElementById("select_aeroporto");

                    select_aeroporto.innerHTML = `<option selected disabled value="null">Selecione um aeroporto</option>`


                    for (let i = 0; i < json_filiais.length; i++) {
                        var filialAtual = json_filiais[i];

                        // Insere cada opção 
                        select_aeroporto.innerHTML += `<option value="${filialAtual.idFilial}">${filialAtual.terminal}</option>`
                    }
                })
            })
            .catch(() => {
                print("Erro ao realizar o Fetch")
            });
    };

function obterDadosGerente(){
    fetch("/dashboards/dashGerenteDados", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
          idUsuarioServer: sessionStorage.idUsuario
        }),
    })
    .then(function (resposta) {
        console.log("resposta do servidor: ", resposta);
        if (resposta.ok) {
            console.log("SUCESSO AO OBTER DADOS DO GERENTE")
            resposta.json().then(json => {
              json_dados = json
              console.log(json_dados)
              // Listar 5 modelos com mais alertas
              menor  = 10**1000
              for(i = 0; i < json_dados.length; i+=3){
                qtdAtual = json_dados[i].qtdAlertas + json_dados[i+1].qtdAlertas + json_dados[i+2].qtdAlertas;
                modelo = {
                  "qtdAlertas":qtdAtual, 
                  "especificacao":json_dados[i].especificacao, 
                  "componente":json_dados[i].componente,
                  "terminal":json_dados[i].terminal,
                  "index": [i, i+1, i+2]
                }
                modelosOrdenados.push(modelo)
              }
                console.log(modelosOrdenados)
                for(i = 1; i < modelosOrdenados.length; i++){
                  for(j = 1; j < modelosOrdenados.length; j++){
                    if(modelosOrdenados[j].qtdAlertas < menor){
                      menor = modelosOrdenados[j].qtdAlertas
                      indexMenor = j
                    }
                  }
                  temp = modelosOrdenados[i]
                  modelosOrdenados[i] = modelosOrdenados[indexMenor]
                  modelosOrdenados[indexMenor] = temp
                }
                console.log(json_dados[modelosOrdenados[3].index[0]].qtdAlertas)
                 alertaBaixo = [json_dados[modelosOrdenados[0].index[0]].qtdAlertas, json_dados[modelosOrdenados[1].index[0]].qtdAlertas, json_dados[modelosOrdenados[2].index[0]].qtdAlertas, json_dados[modelosOrdenados[3].index[0]].qtdAlertas, json_dados[modelosOrdenados[4].index[0]].qtdAlertas]
                 alertaAlto = [json_dados[modelosOrdenados[0].index[1]].qtdAlertas, json_dados[modelosOrdenados[1].index[1]].qtdAlertas, json_dados[modelosOrdenados[2].index[1]].qtdAlertas, json_dados[modelosOrdenados[3].index[1]].qtdAlertas, json_dados[modelosOrdenados[4].index[1]].qtdAlertas]
                 alertaCritico = [json_dados[modelosOrdenados[0].index[2]].qtdAlertas, json_dados[modelosOrdenados[1].index[2]].qtdAlertas, json_dados[modelosOrdenados[2].index[2]].qtdAlertas, json_dados[modelosOrdenados[3].index[2]].qtdAlertas, json_dados[modelosOrdenados[4].index[2]].qtdAlertas]
                 nomesModelos = [modelosOrdenados[0].especificacao, modelosOrdenados[1].especificacao, modelosOrdenados[2].especificacao, modelosOrdenados[3].especificacao]
                console.log(modelosOrdenados)
                console.log(alertaBaixo)
                console.log(alertaAlto)
                console.log(alertaCritico)
                console.log(nomesModelos)
                max = modelosOrdenados[0].qtdAlertas
                console.log(max)
                                console.log(modelosOrdenados[1].componente)
                chart.updateSeries([
                  {
                    name: 'Baixo',
                    data: alertaBaixo
                  },
                  {
                    name: 'Alto',
                    data: alertaAlto
                  },
                  {
                    name: 'Critico',
                    data: alertaCritico
                  }
                ])
                chart.updateOptions({
                  xaxis: {
                    categories: nomesModelos,
                    max: max
                  }
                });
                tabela_comp_1.innerHTML = modelosOrdenados[0].componente
                tabela_comp_2.innerHTML = modelosOrdenados[1].componente
                tabela_comp_3.innerHTML = modelosOrdenados[2].componente
                tabela_comp_4.innerHTML = modelosOrdenados[3].componente
                tabela_comp_5.innerHTML = modelosOrdenados[4].componente
                tabela_modelo_1.innerHTML = modelosOrdenados[0].especificacao
                tabela_modelo_2.innerHTML = modelosOrdenados[1].especificacao
                tabela_modelo_3.innerHTML = modelosOrdenados[2].especificacao
                tabela_modelo_4.innerHTML = modelosOrdenados[3].especificacao
                tabela_modelo_5.innerHTML = modelosOrdenados[4].especificacao
                tabela_total_1.innerHTML = modelosOrdenados[0].qtdAlertas
                tabela_total_2.innerHTML = modelosOrdenados[1].qtdAlertas
                tabela_total_3.innerHTML = modelosOrdenados[2].qtdAlertas
                tabela_total_4.innerHTML = modelosOrdenados[3].qtdAlertas
                tabela_total_5.innerHTML = modelosOrdenados[4].qtdAlertas
                });
        } else {
            // Se não foi ok, mostra mensagem de erro
            return resposta.text().then(erroTexto => {
                throw new Error(erroTexto || "Erro ao cadastrar");
            });
        }
    })
    .catch(function (erro) {
        console.log("Erro na requisição:", erro);
        Swal.fire({
            title: "Erro!",
            text: erro.message || "Erro ao tentar realizar o cadastro. Tente novamente.",
            icon: "error"
        });
    });
  }

  function obterDadosGerenteQtd(){
    fetch("/dashboards/dashGerenteDadosQtd", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
          modelo1Server: modelosOrdenados[0].especificacao,
          modelo2Server: modelosOrdenados[1].especificacao,
          modelo3Server: modelosOrdenados[2].especificacao,
          modelo4Server: modelosOrdenados[3].especificacao,
          modelo5Server: modelosOrdenados[4].especificacao,
          idUsuarioServer: sessionStorage.idUsuario
        }),
    })
    .then(function (resposta) {
        console.log("resposta do servidor: ", resposta);
        if (resposta.ok) {
                      resposta.json().then(json => {
                        qtdMaquinas = json;
                        tabela_qtd_1.innerHTML = qtdMaquinas[0].qtdMaquinas;
                        tabela_qtd_2.innerHTML = qtdMaquinas[1].qtdMaquinas;
                        tabela_qtd_3.innerHTML = qtdMaquinas[2].qtdMaquinas;
                        tabela_qtd_4.innerHTML = qtdMaquinas[3].qtdMaquinas;
                        tabela_qtd_5.innerHTML = qtdMaquinas[4].qtdMaquinas;
                      })
        } else {
            // Se não foi ok, mostra mensagem de erro
            return resposta.text().then(erroTexto => {
                throw new Error(erroTexto || "Erro ao cadastrar");
            });
        }
    })
    .catch(function (erro) {
        console.log("Erro na requisição:", erro);
        Swal.fire({
            title: "Erro!",
            text: erro.message,
            icon: "error"
        });
    });
  }

  abrirMenu();
</script>