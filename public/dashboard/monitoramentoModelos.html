<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="../styles/monitoramentoModelos.css" />
    <link rel="preload" href="../assets/fullscreen.png  " as="image">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../styles/sidebar_marcolino.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="../js/navbarHover.js"></script>
    <title>Alertas por modelo</title>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-1 sidebar d-flex flex-column align-items-center">
                <div id="sidebar">
                    <div class="logo d-flex justify-content-between align-items-center w-100 px-2">
                        <img src="../assets/InnovaairWhite.png" alt="Logo" class="img-fluid" />
                        <button id="closeSidebar" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                    <a href="dashDudu.html"><i class="fas fa-chart-line"></i> <span>Desempenho</span></a>
                    <a href="roberto_Lucas.html"><i class="fas fa-triangle-exclamation"></i> <span>Alertas</span></a>
                    <a href="monitoramentoModelos.html"><i class="fas fa-desktop"></i> <span>Modelo de <br>
                            Maquinas</span></a>
                    <a href="dashRoberto.html"><i class="fas fa-microchip"></i> <span>Modelo de <br>
                            Componentes</span></a>
                    <a onclick="limparSessao()" href="../index.html"><strong>Sair</strong></a>
                </div>
            </div>


            <div style="display: block;" class="popUp">


                <div class="shadow" onclick="abrirPopUp()"></div>

                <div id="mainPopup" class="mainPopup">
                    <img onclick="abrirPopUp()" id="botaoFechar" class="fecharButton" src="../assets/marca-cruzada.png"
                        alt="" loading="eager">

                    <!-- SEÇÃO TITULO DO POPUP -->
                    <div style="min-height: 3em; max-height: 3em;" class="sectionH">
                        <div class="modeloTitulo">Modelo 10093-S</div>

                    </div>

                    <!-- SEÇÃO DO MEIO DO POPUP -->
                    <div style="width: 100%;" class="sectionV">
                        <div style="height: 10%; min-height:30px" class="sectionH">
                            <div class="modeloSubtitulo">Especificações:</div>
                        </div>
                        <div class="specsModelo"></div>
                    </div>

                    <!-- SEÇÃO DO MEIO DO POPUP -->
                    <div style="width: 100%;" class="sectionV graficoHist">

                    </div>



                </div>


            </div>
            <!-- <body onload="tamanhoBarra()
"> -->
            <div id="tela" class="container">
                <div class="child">


                    <div class="tituloContainer">Alertas por modelo</div>
                    <div class="resumoContainer"><i>Visualize os modelos e a quantidade de alertas emitidos por
                            um período de tempo.</i></div>
                    <div class="subtituloContainer">
                        <div id="titulo_select"><b>Selecione a filial</b></div>
                        <select id="select_filial" class="selectBox">
                            <option value="1" selected>Filial 1</option>
                            <option value="2">Filial 2</option>
                        </select>




                    </div>
                    <div id="alertas_kpi_titulo"><b>Quantidade de alertas por modelo</b>
                        <div class="legendaKPI">
                            <div class="box">
                                <div style="background-color: #69d7ff;" class="ball"></div>
                                <span>CPU</span>
                            </div>

                            <div class="box">
                                <div style="background-color: #ff8ca5;" class="ball"></div>
                                <span>RAM</span>
                            </div>

                            <div class="box">
                                <div style="background-color: #e9a276;" class="ball"></div>
                                <span>Disco</span>
                            </div>

                        </div>
                    </div>

                    <div class="main">
                        <div class="section1">

                            <div class="gridTitulo">
                                <span>Modelo</span>
                                <span>Alertas</span>
                                <span>Qtd.</span>
                                <span></span>
                            </div>

                            <div class="containerLista">


                                <!-- <div class="linha">
                                    <span><b>a</b></span>
                                    <span class="barraAlertas"></span>
                                    <span><b>c</b></span>
                                    <span style="cursor:pointer;" class="botaoPop"><b><u>Expandir</u></b></span>
                                </div> -->



                            </div>
                        </div>
                        <div class="KPI">
                            <h2 class="">Total de alertas:</h2>
                            <div style="width: 70%;height:2px; background-color:white"></div>
                            <h1 class="interfaceTOTALALERTAS"></h1>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>
</body>

</html>

<!-- JQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap Bundle JS (popper + bootstrap) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let expanded = false;

    $('#sidebar').on('click', function () {
        if (!expanded) {
            $(this).addClass('expanded');
            expanded = true;
        }
    });

    $('#closeSidebar').on('click', function (e) {
        e.stopPropagation(); // Evita reabrir imediatamente
        $('#sidebar').removeClass('expanded');
        expanded = false;
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>


    // variaveis globais
    let componenteArray = [];
    let ultimoComponente = null;
    let ultimoID = null;

    // evento para mudar de filial

    const linha = document.querySelector(".linha")
    const containerLista = document.querySelector(".containerLista")
    document.getElementById('select_filial').addEventListener('change', function () {
        linha.innerHTML = '';
        listarFilial(this.value);
    });


    let objetoHistorico = {};
    let totalDia = [];
    let componenteDia = [];
    let dias = [];
    async function historicoMaquina(idMaquina) {
        try {
            const res = await fetch(`/models/infoModelos/historico/${idMaquina}`, {
                method: 'GET',
                headers: {
                    "Content-Type": "application/json"
                }
            });

            const filtro = await res.json();

            objetoHistorico = {};
            totalDia = [];
            componenteDia = [];
            dias = [];

            console.log("(1) - FETCH HISTORICO:")
            console.log(filtro)

            Object.values(filtro).forEach(item => {
                if (item.Componente == "Processador" || item.Componente == "RAM" || item.Componente == "Armazenamento") {
                    dias.push(item.Dia)
                    componenteDia.push(item.Componente)
                    totalDia.push(item.total_alertas)
                }
            })

            objetoHistorico = { "Dia": dias, "ComponenteDia": componenteDia, "TotalAlertasDia": totalDia }

            console.log("objetoHistorico:")
            console.log(objetoHistorico)

            return objetoHistorico; // Agora retorna corretamente

        } catch (error) {
            console.error("Erro ao buscar histórico:", error);
            return null;
        }
    }



    listarFilial(1)
    function listarFilial(filialAtual) {
        fetch(`/models/infoModelos/${filialAtual}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then((res) => res.json())
            .then(contador => {

                let valorItem = 0;

                let cpuCount = 0;
                let discoCount = 0;
                let ramCount = 0;

                let baixoCount = 0;
                let altoCount = 0;
                let criticoCount = 0;


                let componentesPorMaquina = {};


                let resultados = [];
                let modeloAnterior = null;
                let quantidade = 0;
                let ultimoItem = null;

                let maquinasContadas = new Set();
                componenteArray = [];

                
                    let QuantidadeDeAlertasTotal = 0;

                for (let i = 0; i < contador.length; i++) {


                    const item = contador[i];
                    let modeloAtual = item.nomeModelo;
                    let idAtual = item.idMaquina;

                    if (modeloAtual !== modeloAnterior) {
                        if (modeloAnterior !== null && ultimoItem !== null) {
                            ultimoItem.altoCount = altoCount;
                            ultimoItem.baixoCount = baixoCount;
                            ultimoItem.criticoCount = criticoCount;
                            ultimoItem.cpuCount = cpuCount;
                            ultimoItem.ramCount = ramCount;
                            ultimoItem.discoCount = discoCount;
                            ultimoItem.quantidade = quantidade;
                            ultimoItem.componentesPorMaquina = componentesPorMaquina;


                            componentesPorMaquina = {}
                            maquinasContadas.clear();
                            resultados.push(ultimoItem);
                        }

                        // Reiniciar contagens
                        cpuCount = 0;
                        ramCount = 0;
                        discoCount = 0;
                        quantidade = 0;

                        baixoCount = 0;
                        altoCount = 0;
                        criticoCount = 0;
                        maquinasContadas = new Set();
                        modeloAnterior = modeloAtual;
                        ultimoItem = item;
                    }

                    if (!maquinasContadas.has(idAtual)) {
                        maquinasContadas.add(idAtual);
                        quantidade++;
                    }

                    if ((item.gravidade == "critico" || item.gravidade == "alto" || item.gravidade == "baixo")) {


                        if (item.gravidade == "baixo") {
                            baixoCount++
                            
                        }
                        if (item.gravidade == "alto") {
                            altoCount++
                            
                        }
                        if (item.gravidade == "critico") {
                            criticoCount++
                            
                        }
                        if (item.componente == "Processador") {
                            cpuCount++;
                            QuantidadeDeAlertasTotal++
                        }
                        if (item.componente == "RAM") {
                            ramCount++;
                            QuantidadeDeAlertasTotal++
                        }
                        if (item.componente == "Armazenamento") {
                            discoCount++;
                            QuantidadeDeAlertasTotal++
                        }
                    }



                    // Este push deve SEMPRE acontecer, pode haver múltiplos componentes para a mesma máquina
                    componenteArray.push({
                        tipo: item.componente,
                        componente: item.especificacao,
                        idMaquina: item.idMaquina,
                        fkFilial: item.fkFilial,
                        nomeModelo: item.nomeModelo
                    });
                }

                console.log("Quantidade de alertasTotal:")
                console.log(QuantidadeDeAlertasTotal)

                document.querySelector(".interfaceTOTALALERTAS").textContent = QuantidadeDeAlertasTotal;
                // Finaliza último modelo
                if (ultimoItem !== null) {
                    ultimoItem.altoCount = altoCount;
                    ultimoItem.baixoCount = baixoCount;
                    ultimoItem.criticoCount = criticoCount;
                    ultimoItem.cpuCount = cpuCount;
                    ultimoItem.ramCount = ramCount;
                    ultimoItem.discoCount = discoCount;
                    ultimoItem.quantidade = quantidade;
                    ultimoItem.componentesPorMaquina = componentesPorMaquina;
                    resultados.push(ultimoItem);
                }

                console.log("Componentes:", componenteArray);
                console.log("Alarmes FULL:", resultados);
                return resultados;
            })

            .then(resultados => {
                //-----------------------------------
                console.log("resultados")
                console.log(resultados)



                // ADICIONANDO IDs CRESCENTES AOS OBJETOS DE RESULTADOS
                for (let i = 0; i < resultados.length; i++) {
                    resultados[i].popupId = i + 1; // ID começando em 1
                }

                console.log("resultados com IDs:");
                console.log(resultados);



                // criando novos modelos na lista grid
                let contadorPopUp = 0;
                let maiorAlerta = 0;

                // for para pegar a maquina com mais alertas (para ser referência para o tamanho das outras barras)
                for (let i = 0; i < resultados.length; i++) {

                    const item = resultados[i];
                    var tamanhototal = item.quantidade;
                    if (tamanhototal > maiorAlerta) {
                        maiorAlerta = tamanhototal;
                    }
                }

                // ORDENANDO DO MAIOR PARA O MENOR
                resultados.sort((a, b) => b.quantidade - a.quantidade);

                for (let i = 0; i < resultados.length; i++) {
                    debugger
                    const item = resultados[i];
                    contadorPopUp++

                    const linha = document.createElement("div");
                    linha.className = "linha";
                    linha.id = `${contadorPopUp}`;
                    containerLista.appendChild(linha)

                    // seção "Modelo"
                    const modeloSpan = document.createElement("span");
                    modeloSpan.className = "itemLista";
                    modeloSpan.id = `${contadorPopUp}`;
                    modeloSpan.textContent = item.nomeModelo;
                    linha.appendChild(modeloSpan);

                    // seção "Alertas"
                    console.log("resultados, quantidade")
                    console.log(item.quantidade)
                    var tamanhoCpu = (item.cpuCount / maiorAlerta) * 100;
                    var tamanhoRam = (item.ramCount / maiorAlerta) * 100;
                    var tamanhoDisco = (item.discoCount / maiorAlerta) * 100;
                    var totalAlertas = (item.discoCount + item.ramCount + item.cpuCount)

                    //-----------------------------------------
                    const alertaSpan = document.createElement("span");
                    alertaSpan.id = `${contadorPopUp}`
                    alertaSpan.className = "itemLista";
                    alertaSpan.style.display = "flex";


                    const barraAlertas = document.createElement("span");
                    barraAlertas.style.width = ((item.quantidade / maiorAlerta) * 100) + "%";
                    barraAlertas.className = "barraAlertas";


                    const qtdAlertas = document.createElement("span");
                    qtdAlertas.textContent = totalAlertas;
                    qtdAlertas.style.width = 20 + "%";
                    qtdAlertas.style.alignSelf = "center";
                    qtdAlertas.style.maxHeight = "20px";
                    qtdAlertas.style.minHeight = "20px";
                    qtdAlertas.className = "itemLista";
                    qtdAlertas.style.marginLeft = "auto";
                    qtdAlertas.style.textAlign = "right";
                    //-----------------------------------------

                    if (tamanhoRam) {
                        const ram = document.createElement("div");
                        ram.className = "aleRam hoverBarra";
                        ram.style.backgroundColor = "#ff8ca5";
                        ram.textContent = item.ramCount;
                        ram.style.height = "100%";
                        ram.style.width = tamanhoRam + "%";
                        ram.style.display = "flex";
                        ram.style.flexGrow = "1";
                        ram.style.alignItems = "center";
                        ram.style.fontWeight = "bolder";
                        ram.style.color = "black";
                        ram.style.justifyContent = "center";

                        barraAlertas.appendChild(ram);
                        console.log("Adicionando ram (Barra de alerta)")
                    }
                    if (tamanhoCpu) {
                        const cpu = document.createElement("div");
                        cpu.className = "aleCpu hoverBarra";
                        cpu.style.backgroundColor = "#69d7ff";
                        cpu.textContent = item.cpuCount;
                        cpu.style.height = "100%";
                        cpu.style.width = tamanhoCpu + "%";
                        cpu.style.display = "flex";
                        cpu.style.flexGrow = "1"
                        cpu.style.alignItems = "center";
                        cpu.style.fontWeight = "bolder";
                        cpu.style.color = "black";
                        cpu.style.justifyContent = "center";
                        barraAlertas.appendChild(cpu);
                        console.log("Adicionando cpu (Barra de alerta)")
                    }

                    if (tamanhoDisco) {
                        const disco = document.createElement("div");
                        disco.className = "aleDisco hoverBarra";
                        disco.style.backgroundColor = "#e9a276";
                        disco.textContent = item.discoCount;
                        disco.style.height = "100%";
                        disco.style.width = tamanhoDisco + "%";
                        disco.style.display = "flex";
                        disco.style.flexGrow = "1";
                        disco.style.alignItems = "center";
                        disco.style.fontWeight = "bolder";
                        disco.style.color = "black";
                        disco.style.justifyContent = "center";
                        barraAlertas.appendChild(disco);
                        console.log("Adicionando disco rígido (Barra de alerta)")
                    }

                    linha.appendChild(alertaSpan);
                    alertaSpan.appendChild(barraAlertas);
                    alertaSpan.appendChild(qtdAlertas);

                    // seção "Quantidade"
                    const quantidade = document.createElement("span");
                    quantidade.className = "itemLista";

                    quantidade.textContent = item.quantidade;
                    linha.appendChild(quantidade)

                    // seção Botão
                    const botaoPop = document.createElement("span");
                    botaoPop.className = "item botaoDiv";
                    botaoPop.innerHTML = `<u><b>Expandir</b></u>`;
                    botaoPop.style.cursor = "pointer"

                    componentesPorMaquina = {};

                    for (let j = 0; j < componenteArray.length; j++) {
                        let componenteAtual = componenteArray[j];
                        let idMaquina = componenteAtual.idMaquina;

                        // Inicializa a máquina se não existir
                        if (!componentesPorMaquina[idMaquina]) {
                            componentesPorMaquina[idMaquina] = {
                                contador: item.quantidade,
                                nomeModelo: item.nomeModelo,
                                criticoCount: item.criticoCount,
                                altoCount: item.altoCount,
                                baixoCount: item.baixoCount
                            };
                        }
                        if (!componentesPorMaquina[idMaquina][componenteAtual.tipo]) {
                            componentesPorMaquina[idMaquina][componenteAtual.tipo] = componenteAtual;
                        }
                    }

                    item.componentesPorMaquina = componentesPorMaquina;

                    console.log("Componentes do pop up1:")
                    console.log(componentesPorMaquina)


                    botaoPop.addEventListener("click", async () => {
                        console.log("Botão clicado - ID do objeto:", item.popupId);
                        console.log("Objeto completo:", item);

                        const historico = await historicoMaquina(item.idMaquina);

                        abrirPopUpComModelo(
                            item.nomeModelo,
                            item.componentesPorMaquina,
                            item.criticoCount,
                            item.altoCount,
                            item.baixoCount,
                            item.popupId,
                            historico
                        );
                    },

                        //    botaoPop.addEventListener("click", () => {
                        //        console.log("Botão clicado - ID do objeto:", item.popupId);
                        //        console.log("Objeto completo:", item);
                        //
                        //        console.log("HistoricoMaquina:")
                        //        console.log(historicoMaquina(item.popupId));
                        //    }




                    );

                    linha.appendChild(botaoPop)
                }
            }



            )
    }


    function abrirPopUpComModelo(nomeModelo, componentesPorMaquina, criticoCount, altoCount, baixoCount, popupId, historicoMaquina) {
        console.log("nomeModelo:", nomeModelo);
        console.log("componentesPorMaquina:", componentesPorMaquina);
        console.log("criticoCount:", criticoCount);
        console.log("altoCount:", altoCount);
        console.log("baixoCount:", baixoCount);
        console.log("popupId:", popupId);

        console.log("Historico maquina:")
        console.log(historicoMaquina)
        console.log("Historico maquina.TotalAlertasDia:")
        console.log(historicoMaquina.TotalAlertasDia)


        const popup = document.querySelector(".popUp");
        const titulo = popup.querySelector(".modeloTitulo");
        const subtitulo = popup.querySelector(".modeloSubtitulo");
        const specs = popup.querySelector(".specsModelo");
        specs.innerHTML = "";


        // histórico de alertas (gráfico linhas)

        // Processar dados em uma linha
        const alertasPorDia = historicoMaquina.Dia.reduce((acc, dia, index) => {
            acc[dia] = (acc[dia] || 0) + historicoMaquina.TotalAlertasDia[index];
            return acc;
        }, {});

        const dias = Object.keys(alertasPorDia).map(Number).sort((a, b) => a - b);
        const valores = dias.map(dia => alertasPorDia[dia]);
        console.log("dias")
        console.log(dias)

        console.log("valores")
        console.log(valores)

        var options = {
            series: [
                {
                    name: "High - 2013",
                    data: valores
                }
            ],
            chart: {
                width: '90%',
                height: '50%',
                type: 'line',
                dropShadow: {
                    enabled: true,
                    color: '#000',
                    top: 18,
                    left: 7,
                    blur: 10,
                    opacity: 0.5
                },
                zoom: {
                    enabled: false
                },
                toolbar: {
                    show: false
                }
            },
            colors: ['#77B6EA', '#545454'],
            dataLabels: {
                enabled: true,
            },
            stroke: {
                curve: 'smooth'
            },
            title: {
                text: `Alertas da maquina ${nomeModelo} nos últimos 30 dias.`,
                align: 'left'
            },
            grid: {
                borderColor: '#e7e7e7',
                row: {
                    colors: ['#f3f3f3', 'transparent'], // takes an array which will be repeated on columns
                    opacity: 0.5
                },
            },
            markers: {
                size: 1
            },
            xaxis: {
                categories: dias,
                title: {
                    text: 'Dia'
                }
            },
            yaxis: {
                title: {
                    text: 'Alertas'
                },
                min: 1,
                max: 100
            },
            legend: {
                position: 'top',
                horizontalAlign: 'right',
                floating: true,
                offsetY: -25,
                offsetX: -5
            }
        };

        var chart = new ApexCharts(document.querySelector(".graficoHist"), options);
        chart.render();







        let chavesMaquinas = Object.keys(componentesPorMaquina);
        console.log("Chaves disponíveis:", chavesMaquinas);
        console.log("PopupId recebido:", popupId);


        let indiceMaquina = (popupId) % chavesMaquinas.length;
        let chaveMaquinaEscolhida = chavesMaquinas[indiceMaquina];
        let maquinaEscolhida = componentesPorMaquina[chaveMaquinaEscolhida];

        console.log("Índice da máquina escolhida:", indiceMaquina);
        console.log("Chave da máquina escolhida:", chaveMaquinaEscolhida);
        console.log("Máquina escolhida:", maquinaEscolhida);

        if (!maquinaEscolhida) {
            specs.innerHTML = "Erro: Máquina não encontrada nos componentes";
            console.error("Máquina não encontrada para o popupId:", popupId);
            return;
        }


        const propriedadesControle = ['contador', 'nomeModelo', 'criticoCount', 'altoCount', 'baixoCount'];

        let componentesEncontrados = false;



        for (let propriedade in maquinaEscolhida) {

            if (propriedadesControle.includes(propriedade)) {
                continue;
            }

            const componente = maquinaEscolhida[propriedade];


            if (componente && typeof componente === 'object' && componente.tipo && componente.componente) {
                specs.innerHTML += "<b>" + componente.tipo + "</b>" + ": " + componente.componente + "<br>";
                componentesEncontrados = true;
            }
        }

        if (!componentesEncontrados) {
            specs.innerHTML += "Nenhum componente encontrado para esta máquina";
            console.warn("Nenhum componente encontrado para a máquina:", chaveMaquinaEscolhida);
        }

        subtitulo.textContent = "Especificações";
        titulo.textContent = `${nomeModelo}`;
        popup.style.display = "flex";
    }

    function abrirPopUp() {
        if (document.querySelector(".popUp").style.display == "none") {
            document.querySelector(".popUp").style.display = "block";
        }
        else {
            document.querySelector(".popUp").style.display = "none";
        }
    }





    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('show');
    }




</script>