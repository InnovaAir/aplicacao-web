<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Alertas por modelo</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles/estilo.css">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../styles/menuLateral.css" />
    <link rel="stylesheet" href="../styles/monitoramentoModelos.css" />
    <link rel="stylesheet" href="../styles/menu_mobile.css" />
    <link rel="preload" href="../assets/fullscreen.png  " as="image">


    <title>Alertas por modelo</title>
</head>
<div style="display: none;" class="popUp">


    <div class="shadow" onclick="abrirPopUp()"></div>

    <div id="mainPopup" class="mainPopup">
        <img onclick="abrirPopUp()" id="botaoFechar" class="fecharButton" src="../assets/marca-cruzada.png" alt=""
            loading="eager">

        <!-- SEÇÃO TITULO DO POPUP -->
        <div style="min-height: 3em; max-height: 3em;" class="sectionH">
            <div class="modeloTitulo">Modelo 10093-S</div>

        </div>

        <!-- SEÇÃO DO MEIO DO POPUP -->
        <div style="height: 13em; " class="sectionH">
            <div style="width: 100%;" class="sectionV">
                <div style="height: 10%; min-height:30px" class="sectionH">
                    <div class="modeloSubtitulo">Especificações:</div>
                </div>
                <div class="specsModelo"></div>
            </div>

            <div style="width: 70%;" class="sectionV">
                <div style="height: 54%; display:flex; bottom:0" class="sectionH graficoTorta">
                </div>
                <div style="height: 45%;" class="sectionH"></div>
            </div>

        </div>

        <!-- SEÇÃO DE BAIXO DO POPUP -->
        <div style="height: 13em;" class="sectionH">
            <div style="width: 100%;" class="sectionV"></div>

        </div>

    </div>


</div>
<!-- <body onload="tamanhoBarra()
"> -->


<div class="sidebar" id="sidebar">
    <div class="d-flex justify-content-center align-items-center px-3 w-100">
        <div class="logo">
            <img src="../assets/InnovaairWhite.png" alt="Logo">
        </div>
        <button class="btn btn-light d-lg-none" type="button" onclick="toggleSidebar()" style="border-radius: 8px;"
            loading="eager">
            ☰
        </button>
    </div>

    <nav class="flex-column">
        <a href="visaoGeral.html">Visão geral</a>
        <a href="tempoReal.html">Tempo real</a>
        <a href="listaMaquinas.html">Lista de máquinas</a>
        <a href="NovosCadastros.html">Cadastrar Máquina</a>
        <a href="monitoramentoModelos.html"><strong>Alertas por modelo</strong></a>

        <a href="suporte.html">Suporte</a>
        <div class="logout mt-3">
            <a href="NovosCadastros.html"><strong>Sair</strong></a>
        </div>
    </nav>
</div>
<div class="menu_mobile">
    <button class="botao_menu_mobile" onclick="abrirMenuMobile()">☰</button>
    <div class="logo_container">
        <img src="../assets/InnovaairWhite.png" alt="" />
    </div>
</div>
<div class="novo_menu">
    <a href="visaoGeral.html" class="agora">Visão geral</a>
    <a href="tempoReal.html">Tempo real</a>
    <a href="listaMaquinas.html">Lista de máquinas</a>
    <a href="NovosCadastros.html">Cadastros</a>
    <a href="suporte.html">Suporte</a>
    <a href="suporte.html">Fale conosco!</a>
</div>
<div class="main d-flex justify-content-center align-items-center" style="padding: 10px;">
    <div id="tela" style="background-color: red;" class="container">
        <div class="child">


            <div class="tituloContainer">Alertas por modelo</div>
            <div class="subtituloContainer">
                <select id="select_filial" class="selectBox">
                    <option value="1" selected>Filial 1</option>
                    <option value="2">Filial 2</option>
                </select>


            </div>

            <div class="section1">
                <div class="container listaModelos">
                    <div>
                        <section class="grid grid-template-columns-3" id="grids">
                            <!-- Titulos -->
                            <div class="item">Modelo</div>
                            <div class="item">Alertas</div>
                            <div class="item">Quantidade</div>
                            <div class="item"></div>

                        </section>
                        <section class="grid grid-template-columns-3" id="lista">


                        </section>

                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>



    // fetch especificações dos totens (1 é o numero estático para testes apenas)

    fetch(`/cadastros/metricas/listar/componentes/1`, {
        method: 'GET',
        headers: {
            "Content-Type": "application/json"
        }
    })
        .then((res) => res.json())
        .then(specs => {
            let componenteArray = [];
            let contador = 0;
            for (let s of specs) {
                contador++;
                componenteArray.push({ id: contador, tipo: s.componente, componente: s.especificacao, fk: s.fkMaquina })
            }
            console.log("Componentes:")
            console.log(componenteArray)
            specs.componenteArray = componenteArray;

        })


    // fetch alertas dos totens
    fetch(`/cadastros/metricas/listar/alertas/1`, {
        method: 'GET',
        headers: {
            "Content-Type": "application/json"
        }
    })
        .then((res) => res.json())
        .then(alertas => {
            let alertasArray = [];
            let alertaAnterior = null;
            let quantidade = 0;

            for (let i = 0; i < alertas.length; i++) {
                const item = alertas[i];
                let nivelAtual = item.idCapturaAlerta;

                if (nivelAtual !== alertaAnterior) {
                    if (alertaAnterior !== null) {
                        alertasArray.push({
                            idCapturaAlerta: alertaAnterior,
                            quantidade: quantidade
                        });
                    }
                    quantidade = 1;
                    alertaAnterior = nivelAtual;
                } else {
                    quantidade++;
                }
            }

            if (alertaAnterior !== null) {
                alertasArray.push({
                    idCapturaAlerta: alertaAnterior,
                    quantidade: quantidade
                });
            }

            console.log("Alertas:");
            return alertasArray;
        })
        .then(alerta => console.log(alerta));

    let componenteArray = [];
    let ultimoComponente = null;
    let ultimoID = null;


    document.getElementById('select_filial').addEventListener('change', function () {
        lista.innerHTML = '';
        listarFilial(this.value);
    });

    function listarFilial(filialAtual) {
        fetch(`/models/infoModelos/${filialAtual}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then((res) => res.json())
            .then(contador => {

                let cpuCount = 0;
                let discoCount = 0;
                let ramCount = 0;

                let baixoCount = 0;
                let altoCount = 0;
                let criticoCount = 0;

                let resultados = [];
                let modeloAnterior = null;
                let quantidade = 0;
                let ultimoItem = null;

                let maquinasContadas = new Set();
                componenteArray = [];

                for (let i = 0; i < contador.length; i++) {
                    const item = contador[i];
                    let modeloAtual = item.nomeModelo;
                    let idAtual = item.idMaquina;

                    if (modeloAtual !== modeloAnterior) {
                        if (modeloAnterior !== null && ultimoItem !== null) {
                            ultimoItem.altoCount = altoCount;
                            ultimoItem.baixoCount = baixoCount;
                            ultimoItem.criticoCount = criticoCount;
                            ultimoItem.cpuCount = cpuCount;
                            ultimoItem.ramCount = ramCount;
                            ultimoItem.discoCount = discoCount;
                            ultimoItem.quantidade = quantidade;
                            maquinasContadas.clear;
                            resultados.push(ultimoItem);
                        }

                        // Reiniciar contagens
                        cpuCount = 0;
                        ramCount = 0;
                        discoCount = 0;
                        quantidade = 0;

                        baixoCount = 0;
                        altoCount = 0;
                        criticoCount = 0;
                        modeloAnterior = modeloAtual;
                        ultimoItem = item;
                    }

                    if (!maquinasContadas.has(idAtual)) {
                        maquinasContadas.add(idAtual);
                        quantidade++;
                    }
                    if (item.gravidade == "critico") criticoCount++;
                    if (item.gravidade == "alta") altoCount++;
                    if (item.gravidade == "baixa") baixoCount++;

                    if (item.componente == "Processador") cpuCount++;
                    if (item.componente == "RAM") ramCount++;
                    if (item.componente == "Armazenamento") discoCount++;




                    // Este push deve SEMPRE acontecer, pode haver múltiplos componentes para a mesma máquina
                    componenteArray.push({
                        tipo: item.componente,
                        componente: item.especificacao,
                        idMaquina: item.idMaquina,
                        fkFilial: item.fkFilial
                    });
                }

                // Finaliza último modelo
                if (ultimoItem !== null) {
                    ultimoItem.altoCount = altoCount;
                    ultimoItem.baixoCount = baixoCount;
                    ultimoItem.criticoCount = criticoCount;
                    ultimoItem.cpuCount = cpuCount;
                    ultimoItem.ramCount = ramCount;
                    ultimoItem.discoCount = discoCount;
                    ultimoItem.quantidade = quantidade;
                    resultados.push(ultimoItem);
                }

                console.log("Componentes:", componenteArray);
                console.log("Alarmes FULL:", resultados);
                return resultados;
            })

            .then(resultados => {
                //-----------------------------------
                console.log("resultados")
                console.log(resultados)

                // ADICIONANDO IDs CRESCENTES AOS OBJETOS DE RESULTADOS
                for (let i = 0; i < resultados.length; i++) {
                    resultados[i].popupId = i + 1; // ID começando em 1
                }

                console.log("resultados com IDs:");
                console.log(resultados);


                // criando novos modelos na lista grid
                let contadorPopUp = 0;
                let maiorAlerta = 0;

                // for para pegar a maquina com mais alertas (para ser referência para o tamanho das outras barras)
                for (let i = 0; i < resultados.length; i++) {
                    const item = resultados[i];
                    var tamanhototal = item.quantidade;
                    if (tamanhototal > maiorAlerta) {
                        maiorAlerta = tamanhototal;
                    }
                }

                for (let i = 0; i < resultados.length; i++) {
                    const item = resultados[i];
                    contadorPopUp++

                    // seção "Modelo"
                    const modeloDiv = document.createElement("div");
                    modeloDiv.className = "item modeloDiv";
                    modeloDiv.id = `${contadorPopUp}`;
                    modeloDiv.textContent = item.nomeModelo;
                    lista.appendChild(modeloDiv);

                    // seção "Alertas"
                    console.log("resultados, quantidade")
                    console.log(item.quantidade)
                    var tamanhoCpu = (item.cpuCount / maiorAlerta) * 100;
                    var tamanhoRam = (item.ramCount / maiorAlerta) * 100;
                    var tamanhoDisco = (item.discoCount / maiorAlerta) * 100;
                    var totalAlertas = (item.discoCount + item.ramCount + item.cpuCount)

                    //-----------------------------------------
                    const alertaDiv = document.createElement("div");
                    alertaDiv.className = "item barraDiv ";
                    alertaDiv.id = `${contadorPopUp}`
                    alertaDiv.style.display = "flex ";
                    alertaDiv.style.justifyContent = "center; ";

                    const barraAlertas = document.createElement("div");
                    barraAlertas.style.width = ((item.quantidade / maiorAlerta) * 100) + "%";
                    barraAlertas.className = "barraAlertas";
                    barraAlertas.style.justifySelf = "flex-start"
                    barraAlertas.style.maxHeight = "20px"
                    barraAlertas.style.minHeight = "20px"
                    barraAlertas.style.justifyContent = "flex-start"

                    const qtdAlertas = document.createElement("div");
                    qtdAlertas.textContent = totalAlertas;
                    qtdAlertas.style.width = 20 + "%";
                    qtdAlertas.className = "qtdAlertas";
                    qtdAlertas.style.alignSelf = "center";
                    qtdAlertas.style.maxHeight = "20px";
                    qtdAlertas.style.minHeight = "20px";
                    qtdAlertas.style.marginLeft = "auto";
                    qtdAlertas.style.marginRight = "7px";
                    qtdAlertas.style.textAlign = "right";
                    //-----------------------------------------

                    if (tamanhoRam) {
                        const ram = document.createElement("div");
                        ram.className = "aleRam hoverBarra";
                        ram.style.backgroundColor = "yellow";
                        ram.style.height = "100%";
                        ram.style.width = tamanhoRam + "%";
                        ram.style.display = "flex";
                        ram.style.flexGrow = "1"
                        barraAlertas.appendChild(ram);
                        console.log("Adicionando ram (Barra de alerta)")
                    }
                    if (tamanhoCpu) {
                        const cpu = document.createElement("div");
                        cpu.className = "aleCpu hoverBarra";
                        cpu.style.backgroundColor = "red";
                        cpu.style.height = "100%";
                        cpu.style.width = tamanhoCpu + "%";
                        cpu.style.display = "flex";
                        cpu.style.flexGrow = "1"
                        barraAlertas.appendChild(cpu);
                        console.log("Adicionando cpu (Barra de alerta)")
                    }

                    if (tamanhoDisco) {
                        const disco = document.createElement("div");
                        disco.className = "aleDisco hoverBarra";
                        disco.style.backgroundColor = "cyan";
                        disco.style.height = "100%";
                        disco.style.width = tamanhoDisco + "%";
                        disco.style.display = "flex";
                        disco.style.flexGrow = "1"
                        barraAlertas.appendChild(disco);
                        console.log("Adicionando disco rígido (Barra de alerta)")
                    }

                    lista.appendChild(alertaDiv);
                    alertaDiv.appendChild(barraAlertas);
                    alertaDiv.appendChild(qtdAlertas);

                    // seção "Quantidade"
                    const quantidade = document.createElement("div");
                    quantidade.className = "item quantidadeDiv ";
                    quantidade.textContent = item.quantidade;
                    lista.appendChild(quantidade)

                    // seção Botão
                    const botaoPop = document.createElement("div");
                    botaoPop.className = "item botaoDiv";
                    botaoPop.innerHTML = `<img id="${contadorPopUp}" onclick="abrirPopUp()" style="height: 1.5em; cursor:pointer;"
                            src="../assets/fullscreen.png" alt="" loading="eager">`;

                    let componentesPorMaquina = {};

                    for (let j = 0; j < componenteArray.length; j++) {
                        let componenteAtual = componenteArray[j];
                        let idMaquina = componenteAtual.idMaquina;

                        // Inicializa a máquina se não existir
                        if (!componentesPorMaquina[idMaquina]) {
                            componentesPorMaquina[idMaquina] = {
                                contador: item.quantidade,
                                nomeModelo: item.nomeModelo,
                                criticoCount: item.criticoCount,
                                altoCount: item.altoCount,
                                baixoCount: item.baixoCount
                            };
                        }
                        if (!componentesPorMaquina[idMaquina][componenteAtual.tipo]) {
                            componentesPorMaquina[idMaquina][componenteAtual.tipo] = componenteAtual;
                        }
                    }

                    console.log("Componentes do pop up1:")
                    console.log(componentesPorMaquina)

                    // USANDO O ID DO OBJETO PARA O EVENT LISTENER
                    botaoPop.addEventListener("click", () => {
                        // Agora você pode usar item.popupId para identificar qual objeto corresponde ao botão
                        console.log("Botão clicado - ID do objeto:", item.popupId);
                        console.log("Objeto completo:", item);

                        abrirPopUpComModelo(
                            item.nomeModelo,
                            componentesPorMaquina,
                            item.criticoCount,
                            item.altoCount,
                            item.baixoCount,
                            item.popupId // Usando o ID do objeto
                        );
                    });

                    lista.appendChild(botaoPop)
                }
            }



            )
    }

    let chartPopUp = null; // variável global para o gráfico

    function abrirPopUpComModelo(nomeModelo, componentesPorMaquina, criticoCount, altoCount, baixoCount, popupId) {
        console.log("nomeModelo:", nomeModelo);
        console.log("componentesPorMaquina:", componentesPorMaquina);
        console.log("criticoCount:", criticoCount);
        console.log("altoCount:", altoCount);
        console.log("baixoCount:", baixoCount);
        console.log("popupId:", popupId);

        if (chartPopUp !== null) {
            chartPopUp.destroy();
            chartPopUp = null;
        }

        const popup = document.querySelector(".popUp");
        const titulo = popup.querySelector(".modeloTitulo");
        const subtitulo = popup.querySelector(".modeloSubtitulo");
        const specs = popup.querySelector(".specsModelo");
        specs.innerHTML = "";

        // gráfico de torta da quantidade de alertas
        var options = {
            series: [criticoCount, altoCount, baixoCount],
            chart: {
                width: "70%",
                type: 'pie',
            },
            labels: ['Crítico', 'Alto', 'Baixo'],
            responsive: [{
                breakpoint: 480,
                options: {
                    chart: {
                        width: 40,
                        height: 40
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }]
        };
        chartPopUp = new ApexCharts(document.querySelector(".graficoTorta"), options);
        chartPopUp.render();

        console.log("Estrutura completa de componentesPorMaquina:");
        console.log(componentesPorMaquina);


        let chavesMaquinas = Object.keys(componentesPorMaquina);
        console.log("Chaves disponíveis:", chavesMaquinas);
        console.log("PopupId recebido:", popupId);


        let indiceMaquina = (popupId) % chavesMaquinas.length;
        let chaveMaquinaEscolhida = chavesMaquinas[indiceMaquina];
        let maquinaEscolhida = componentesPorMaquina[chaveMaquinaEscolhida];

        console.log("Índice da máquina escolhida:", indiceMaquina);
        console.log("Chave da máquina escolhida:", chaveMaquinaEscolhida);
        console.log("Máquina escolhida:", maquinaEscolhida);

        if (!maquinaEscolhida) {
            specs.innerHTML = "Erro: Máquina não encontrada nos componentes";
            console.error("Máquina não encontrada para o popupId:", popupId);
            return;
        }


        const propriedadesControle = ['contador', 'nomeModelo', 'criticoCount', 'altoCount', 'baixoCount'];

        let componentesEncontrados = false;



        for (let propriedade in maquinaEscolhida) {

            if (propriedadesControle.includes(propriedade)) {
                continue;
            }

            const componente = maquinaEscolhida[propriedade];


            if (componente && typeof componente === 'object' && componente.tipo && componente.componente) {
                specs.innerHTML += "<b>" + componente.tipo + "</b>" + ": " + componente.componente + "<br>";
                componentesEncontrados = true;
            }
        }

        if (!componentesEncontrados) {
            specs.innerHTML += "Nenhum componente encontrado para esta máquina";
            console.warn("Nenhum componente encontrado para a máquina:", chaveMaquinaEscolhida);
        }

        subtitulo.textContent = "Especificações";
        titulo.textContent = `${nomeModelo}`;
        popup.style.display = "flex";
    }

    function abrirPopUp() {
        if (document.querySelector(".popUp").style.display == "none") {
            document.querySelector(".popUp").style.display = "block";
        }
        else {
            document.querySelector(".popUp").style.display = "none";
        }
    }





    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('show');
    }




</script>